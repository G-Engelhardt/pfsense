# Autor: Robson Vaamonde
# Site: www.vaamonde.com.br
# Facebook: facebook.com/ProcedimentosEmTI
# Facebook: facebook.com/BoraParaPratica
# YouTube: youtube.com/BoraParaPratica
# Instagram: instagram.com/procedimentoem/
# Linkedin: linkedin.com/in/robson-vaamonde-0b029028/
# Data de criação: 11/12/2020
# Data de atualização: 18/12/2020
# Versão: 0.02

Hardware utilizados no Projeto-01 de Firewall pfSense

01 (um) Appliance J1900
01 (um) Link de WAN Vivo Fibra (Bridge Mode)
01 (um) Link de WAN NET (Bridge Mode)

Netgear pfSense 2.4.5 (RELEASE-p1 - FreeBSD 11.3-STABLE)

#Configuração geral do webConfigurator do pfSense
System
	General Setup
		System
			Hostname: srvfw
			Domain: domain.local
		DNS Server Settings
			DNS Servers: 8.8.8.8
						 8.8.4.4
		DNS Server Override: OFF
		Disable DNS Forwarder: OFF
		Localization
			Timezone: America/Recife (Resolve o problema do Horário de Verão)
			Timerservers: a.st1.ntp.br
			Language: English
		webConfigurator
			Theme: pfSense-dark
			Top Navigation: Scroolls with page
			Hostname in Menu: Fully Qualified Domain Name
			Dashboard Columms: 3
			Interfaces Sort: 
				Sort Alphavetically: ON
		Associated Panel Show/Hide:
			Available Widgest: ON
			Log Filter: ON
			Manage Log: ON
			Monitoring: ON
		Require State Filter: 
			Do not display state table without a filter: OFF
		Left Columm Labels
			ACtive: OFF
		Alias Popups:
			Disable details in alias popups: OFF
		Disable dragging:
			Disable dragging of firewall/nat rules: OFF
		Login page color: Dark Blue
		Login hostname 
			Show hostname on login banner: ON
	save

#Configuração do Dashboard do pfSense
Dashboard	
	Available Widgest
		System Information: ON
		Interfaces: ON
		Gateways: ON
		NTP Status: ON
		Service Status: ON
		Load Balancer Status: ON
		Traffic Graphs: ON
		Firewall Logs: ON
		Interface Statistics: ON
        Dynamic DNS Status: ON
        IPSec: ON
        OpenVPN: ON
		save

#Configuração do CA e do Certificado SSL do pfSense
System
	Certificate Manager
		CAs
			ADD
				Create / Edit CA
					Descriptive name: EMPRESA
					Method: Create an internel Certificate Authority
				Internal Certificate Authority
					Key lenght (bits): 2048
					Digest Algorithm: sha256
					Lifetime (days): 3650
					Common Name: empresa-ca
					Country Code: BR 
					Sate or Province: Sao Paulo
					City: Sao Paulo 
					Organization: Empresa XYZ
					Organizational Unit: Matriz Sao Paulo
			save
		Certificates
			Add/Sign 
				Add/Sign a New Certificate
					Method: Create an internal Certificate
					Descriptive name: Certificado EMPRESA Firewall
				Internal Certificate 
					Certificate authority: EMPRESA 
					Key lenght: 2038
					Digest Algorithm: sha256
					Lifetime (days): 3650
					Common Name: empresa.local 
					Country Code: BR
					State or Province: Sao Paulo
					City: Sao Paulo
					Organization: EMPRESA
					Organization Unit: Matriz Sao Paulo 
				Certificate Attributes
					Certificate Type: Server Certificate
					Alternative Names:
						IP Address: IP_SERVER
						FQDN or Hostname: NAME_SERVER
						FQDN or Hostname: NAME_FQDN_SERVER
				save

#Configuração avançada do webConfigurator do pfSense
System
	Advanced
		Admin Access
			webConfigurator
				Protocol: HTTPS
				SSL/TLS Certificate: Certificado EMPRESA Firewall
				TCP port: Default
				Max Processes: 2
				WebGUI redirect: OFF
				HTS: OFF
				OCSP Must-Staple: OFF
				WebGUI Login Autocomplete: ON
				WebGUI login messages: OFF
				Anti-lockout: OFF
				DNS Rebind Check: OFF
				Alternate Hostnames: OFF
				Browser HTTP_REFERER enforcement: OFF
				Browser tab text: OFF
			Secure Shell
				Secure Shell Server: ON
				SSHd Key Only: Password or Public Key
				Allow Agent Forwarding: OFF
				SSH Port: 22
			Login Protection
				Threshold: 30
				Blocktime: 120
				Detection time: 1800
				Whitelist: Default
			Serial Communications
				Serial Terminal: OFF
				Serial Speed: 115200
				Primary Console: Serial Console
			Console Options
				Console menu: ON
			save

#Configuração das Interfaces de WAN e LAN do pfSense
Interfaces
	Assignments
		Interface Assignments
			LAN (em0)
				General Configuration
					Enable: ON
					Description: LAN
					IPv4 Configuration Type: Static IPv4
					IPv6 Configuration Type: None
					MAC Address: OFF
					MTU: OFF
					MSS: OFF
					Speed and Duplex: Default (no preference, typically autoselect)
				Static IPv4 Configuration
					IPv4 Address: IPV4_GATEWAY/24
					IPv4 Upstream Gateway: None
				Reserved Networks
					Block private networks and loopback addresses: OFF
					Block bogon networks: OFF
				save
				Apply Changes
			WAN1 (em1) VIVO
				General Configuration
					Enable: ON
					Description: LAN
					IPv4 Configuration Type: DHCP
					IPv6 Configuration Type: None
					MAC Address: OFF
					MTU: OFF
					MSS: OFF
					Speed and Duplex: Default (no preference, typically autoselect)
				DHCP Client Configuration
					Options: OFF
					Configuration Override: OFF
					Hostname: OFF
					Alias IPv4 address: OFF
					Reject leases from: OFF
				Reserved Networks
					Block private networks and loopback addresses: ON
					Block bogon networks: ON
				save
				Apply Changes
			WAN2 (em2) NET
				General Configuration
					Enable: ON
					Description: LAN
					IPv4 Configuration Type: DHCP
					IPv6 Configuration Type: None
					MAC Address: OFF
					MTU: OFF
					MSS: OFF
					Speed and Duplex: Default (no preference, typically autoselect)
				DHCP Client Configuration
					Options: OFF
					Configuration Override: OFF
					Hostname: OFF
					Alias IPv4 address: OFF
					Reject leases from: OFF
				Reserved Networks
					Block private networks and loopback addresses: ON
					Block bogon networks: ON
				save
				Apply Changes

#Configuração do recurso de Failover e Failback das Interfaces de WAN do pfSense
System
    Advanced
        Miscellaneous
            Load Balancing
                Load Balancing: ON
        save
    Routing
        Gateway Groups
            ADD
                Edit Gateway Group Entry
                    Group Name: HA_LB_Internet
                    Gateway Priority
                        WAN1_DHCP   Tier 1  Interface Address  Interface VIVO
                        WAN1_DHCP   Tier 2  Interface Address  Interface NET
                    Trigger Level: Packet Loss or High Latency
                    Description: Grupo de Interfaces de Gateway Vivo e NET
                save
                Apply Changes
        Gateways
            Default Gateway
                Default gateway IPv4: HA_LB_Internet
                Default gateway IPv6: Automatic
            save
            Apply Changes
        Gateways
            WAN1_DHCP
                Edit
                    Edit Gateway
                        Monitor IP: 8.8.8.8
                        Description: Interface VIVO
                    Display Advanced
                        Latency thresholds: 400 600
                        Packet Loss thresholds: 30% 40%
                    save
                    Apply Changes
            WAN2_DHCP
                Edit
                    Edit Gateway
                        Monitor IP: 8.8.4.4
                        Description: Interface NET
                    Display Advanced
                        Latency thresholds: 400 600
                        Packet Loss thresholds: 30% 40%
                    save
                    Apply Changes

#Configuração do recurso de NTP Server do pfSense
Services
    NTP
        Settings
            NTP Server Configuration
                Interface: LAN
                Time Services:  a.st1.ntp.br is a Pool
                                a.ntp.br is a Pool
                Orphan Mode: DEFAULT
                NTP Graphs: ON
                Logging: ON
                Statistics Logging: ON
                Lep seconds: DEFAULT
            save

#Configuração do recurso de Dynamic DNS No-IP do pfSense
Services
    Dynamic DNS
        Dynamic DNS Client
            ADD
                Disable: OFF
                Service Type: No-IP (free)
                Interface to monitor: GW Group HA_LB_Internet
                Hostname: NOME_SERVIDOR_NOIP.ddns.net
                MX: OFF
                Wilcards: OFF
                Verbose logging: ON
                Username: EMPRESA
                Password: SENHA_EMPRESA
                Confirm: SENHA_EMPRESA
                Description: No-IP Dynamic DNS
            save

#Configuração do recurso de DHCP Server do pfSense
Services
    DHCP Server
        LAN
            General Options
                Enable: ON
                BOOTP: ON
                Deny unknown clients: OFF
                Ignore denied clients: OFF
                Ignore client identifiers: OFF
                Subnet: PADRÃO DA INTERFACE LAN
                Range: From IP_DE_INÍCIO To IP_DE_FIM
            Additional Pools
                Add: OFF
            Servers
                WINS servers: IPV4_GATEWAY
                DNS servers: IPV4_GATEWAY
            Other Options
                Gateway: 172.16.10.254
                Domain name: empresa.local
                Domain search list: empresa.local
                Default lease time: DEFAULT
                Maximum lease time: DEFAULT
                Failover peer IP: OFF
                Static ARP: OFF
                Time format change: OFF
                Statistics graphs: ON
                Ping check: OFF
            Dynamic DNS: DEFAULT
            MAC address control: DEFAULT
            NTP:
                NTP Server 1: IPV4_GATEWAY
            TFTP: DEFAULT
            LDAP: DEFAULT
            Network Booting: DEFAULT
            Additional BOOTP/DHCP Options: DEFAULT
            DHCP Static Mappings for this Interface: DEFAULT
        save

#Configuração das regras de Firewall da LAN do pfSense
Firewall
    Rules 
        LAN
            Separator
                Regras Padrão Desativas
                    IPv4 LAN Net Disable
                    IPv6 LAN Net Disable
            Separator
                Regras de Liberação dos Serviços para a Internet
                    ADD
                        Edit File Rule
                            Action: Pass
                            Disable: OFF
                            Interfaces: LAN
                            Address Family: IPv4
                            Protocol: ICMP
                            ICMP Subtypes: ALL
                        Source
                            Source: LAN Net
                        Destination
                            Destination: any
                        Extra Options
                            Log: ON
                            Description: Liberação o ICMP para toda a Rede LAN Net
                        Advanced Options
                            Gateway: HA_LB_Internet
                    save
                    ADD
                        Edit File Rule
                            Action: Pass
                            Disable: OFF
                            Interfaces: LAN
                            Address Family: IPv4
                            Protocol: UDP
                            ICMP Subtypes: ALL
                        Source
                            Source: LAN Net
                        Destination
                            Destination: any
                            Destination Port Range: From DNS (53) To DNS (53)
                        Extra Options
                            Log: ON
                            Description: Liberação o DNS para toda a Rede LAN Net
                        Advanced Options
                            Gateway: HA_LB_Internet
                    save
                    ADD
                        Edit File Rule
                            Action: Pass
                            Disable: OFF
                            Interfaces: LAN
                            Address Family: IPv4
                            Protocol: TCP
                            ICMP Subtypes: ALL
                        Source
                            Source: LAN Net
                        Destination
                            Destination: any
                            Destination Port Range: From HTTP (80) To HTTP (80)
                        Extra Options
                            Log: ON
                            Description: Liberação o HTTP para toda a Rede LAN Net
                        Advanced Options
                            Gateway: HA_LB_Internet
                    save
                    ADD
                        Edit File Rule
                            Action: Pass
                            Disable: OFF
                            Interfaces: LAN
                            Address Family: IPv4
                            Protocol: TCP
                            ICMP Subtypes: ALL
                        Source
                            Source: LAN Net
                        Destination
                            Destination: any
                            Destination Port Range: From HTTPS (443) To HTTPS (443)
                        Extra Options
                            Log: ON
                            Description: Liberação o HTTPS para toda a Rede LAN Net
                        Advanced Options
                            Gateway: HA_LB_Internet
                    save
                    ADD
                        Edit File Rule
                            Action: Pass
                            Disable: OFF
                            Interfaces: LAN
                            Address Family: IPv4
                            Protocol: TCP
                            ICMP Subtypes: ALL
                        Source
                            Source: LAN Net
                        Destination
                            Destination: any
                            Destination Port Range: From FTP (21) To HTTPS (21)
                        Extra Options
                            Log: ON
                            Description: Liberação o FTP para toda a Rede LAN Net
                        Advanced Options
                            Gateway: HA_LB_Internet
                    save
                    Apply Changes

#Configuração das regras de NAT Port Forwarder